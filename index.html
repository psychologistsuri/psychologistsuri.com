<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Surendra Bisht</title>

    <script>
      (function () {
        const key = "ps_theme";
        const saved = localStorage.getItem(key);
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        const theme = saved === "dark" || saved === "light" ? saved : prefersDark ? "dark" : "light";
        if (theme === "dark") document.documentElement.classList.add("dark");
        document.documentElement.style.colorScheme = theme;
      })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>

    <style>
      html.dark {
        color-scheme: dark;
      }

      body.theme-fade,
      * {
        transition: background-color 0.15s, color 0.15s, border-color 0.15s, fill 0.15s,
          stroke 0.15s;
      }

      body.is-switching {
        opacity: 0.94;
      }

      .proseish h1 {
        font-size: 1.9rem;
        font-weight: 700;
        margin: 1.5rem 0;
      }

      .proseish h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 1.25rem 0;
      }

      .proseish p {
        margin: 0.75rem 0;
      }

      .proseish ul {
        list-style: disc;
        padding-left: 1.2rem;
      }

      .proseish blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 1rem;
        margin: 1rem 0;
      }

      .dark .proseish blockquote {
        border-left-color: #334155;
      }

      .proseish code {
        background: #f3f4f6;
        padding: 0.2rem 0.4rem;
        border-radius: 0.6rem;
      }

      .dark .proseish code {
        background: #0f172a;
      }

      .proseish pre {
        background: #020617;
        color: #e5e7eb;
        padding: 1rem;
        border-radius: 1rem;
        overflow: auto;
      }
    </style>
  </head>

  <body class="bg-white text-zinc-950 dark:bg-zinc-950 dark:text-zinc-50 theme-fade">
    <div
      id="loader"
      class="fixed inset-0 z-50 flex items-center justify-center bg-white text-zinc-950 dark:bg-zinc-950 dark:text-zinc-50"
      aria-live="polite"
      aria-busy="true"
    >
      <div class="flex flex-col items-center gap-4 px-6 text-center">
        <div class="text-3xl">‚è≥</div>
        <div class="text-lg font-semibold">Website loading...</div>
        <div class="text-sm text-zinc-600 dark:text-zinc-300">
          Preparing articles and layout. Please wait.
        </div>
      </div>
    </div>

    <header
      class="border-b border-zinc-300 dark:border-zinc-700 bg-white/80 dark:bg-zinc-950/80 backdrop-blur"
    >
      <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
        <a href="#/" class="font-semibold tracking-tight">Surendra Bisht</a>

        <div class="flex items-center gap-2">
          <nav class="hidden sm:flex gap-1 text-sm">
            <a
              href="#/"
              class="px-4 py-2 rounded-full border border-transparent hover:border-zinc-300 dark:hover:border-zinc-700"
              >Articles</a
            >
            <a
              href="#/about"
              class="px-4 py-2 rounded-full border border-transparent hover:border-zinc-300 dark:hover:border-zinc-700"
              >About</a
            >
          </nav>

          <button
            id="themeToggle"
            class="h-10 w-10 rounded-full border-2 border-zinc-300 dark:border-zinc-700 flex items-center justify-center"
            aria-label="Toggle theme"
            type="button"
          ></button>
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-10">
      <section id="listView">
        <div class="flex flex-col sm:flex-row gap-6 justify-between">
          <div>
            <h1 class="text-3xl font-bold">Articles</h1>
            <p class="text-zinc-600 dark:text-zinc-300 mt-1">
              Applied psychology, inclusive education & counseling
            </p>
          </div>

          <div class="w-full sm:w-80">
            <div
              class="flex items-center h-11 rounded-full border-2 border-zinc-300 dark:border-zinc-700 bg-white dark:bg-zinc-950 px-4 gap-3"
            >
              <span class="text-zinc-400" aria-hidden="true">üîç</span>
              <input
                id="search"
                type="text"
                placeholder="Search articles"
                class="w-full bg-transparent outline-none text-sm"
                autocomplete="off"
              />
            </div>
          </div>
        </div>

        <div id="articleList" class="mt-8 grid gap-4"></div>
      </section>

      <section id="articleView" class="hidden">
        <div class="flex justify-between mb-6">
          <a
            href="#/"
            class="px-4 py-2 rounded-full border-2 border-zinc-300 dark:border-zinc-700"
            >Back</a
          >
          <button
            id="copyLinkBtn"
            class="px-4 py-2 rounded-full border-2 border-zinc-300 dark:border-zinc-700"
            type="button"
          >
            Copy link
          </button>
        </div>

        <h1 id="articleTitle" class="text-3xl font-bold"></h1>
        <div id="articleBody" class="mt-8 proseish"></div>
      </section>

      <section id="aboutView" class="hidden">
        <div class="rounded-3xl border-2 border-zinc-300 dark:border-zinc-700 p-6">
          <h1 class="text-2xl font-bold">About</h1>
          <p class="mt-2 text-zinc-600 dark:text-zinc-300">
            Special Educator & School Counselor ‚Äî Applied Psychology
          </p>
        </div>
      </section>
    </main>

    <script>
      const INDEX_URL = "/articles/index.json";
      const BASE = "/articles/";
      const qs = (s) => document.querySelector(s);

      marked.setOptions({
        gfm: true,
        breaks: false,
        mangle: false,
        headerIds: false,
        highlight(code, lang) {
          try {
            if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
            return hljs.highlightAuto(code).value;
          } catch {
            return code;
          }
        },
      });

      function setTheme(theme) {
        document.documentElement.classList.toggle("dark", theme === "dark");
        document.documentElement.style.colorScheme = theme;
        localStorage.setItem("ps_theme", theme);
      }

      function syncThemeIcon() {
        const btn = qs("#themeToggle");
        const isDark = document.documentElement.classList.contains("dark");
        btn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      }

      syncThemeIcon();

      qs("#themeToggle").addEventListener("click", () => {
        const next = document.documentElement.classList.contains("dark") ? "light" : "dark";
        localStorage.setItem("ps_theme", next);
        location.reload();
      });

      async function loadIndex() {
        const res = await fetch(INDEX_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load index.json");
        const data = await res.json();
        return Array.isArray(data.files) ? data.files : [];
      }

      async function fetchText(file) {
        const res = await fetch(BASE + file, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to load article");
        return await res.text();
      }

      function parseTitle(md) {
        const m = md.match(/^#\s+(.+)\s*$/m);
        return m ? m[1].trim() : "Untitled";
      }

      function stripLeadingH1(md) {
        return md.replace(/^\s*#\s+.+\s*\n+/, "");
      }

      function slug(s) {
        return s
          .toLowerCase()
          .trim()
          .replace(/['"]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");
      }

      function show(viewId) {
        qs("#listView").classList.add("hidden");
        qs("#articleView").classList.add("hidden");
        qs("#aboutView").classList.add("hidden");
        qs(viewId).classList.remove("hidden");
      }

      function renderList(items) {
        const list = qs("#articleList");
        list.innerHTML = "";

        for (const item of items) {
          const a = document.createElement("a");
          a.href = "#/article/" + encodeURIComponent(item.slug);
          a.className =
            "block p-5 rounded-3xl border-2 border-zinc-300 dark:border-zinc-700 hover:bg-zinc-100 dark:hover:bg-zinc-900";
          a.textContent = item.title;
          list.appendChild(a);
        }

        const search = qs("#search");
        search.value = "";
        search.oninput = (e) => {
          const q = (e.target.value || "").toLowerCase();
          for (const c of list.children) {
            const t = (c.textContent || "").toLowerCase();
            c.style.display = t.includes(q) ? "block" : "none";
          }
        };
      }

      function wireCopyLink() {
        const btn = qs("#copyLinkBtn");
        btn.onclick = async () => {
          const url = location.href;
          try {
            await navigator.clipboard.writeText(url);
            btn.textContent = "Copied";
            window.setTimeout(() => (btn.textContent = "Copy link"), 900);
          } catch {
            const ta = document.createElement("textarea");
            ta.value = url;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            try {
              document.execCommand("copy");
              btn.textContent = "Copied";
              window.setTimeout(() => (btn.textContent = "Copy link"), 900);
            } finally {
              ta.remove();
            }
          }
        };
      }

      async function buildItems(files) {
        const items = [];
        for (const f of files) {
          try {
            const md = await fetchText(f);
            const title = parseTitle(md);
            const s = slug(title);
            items.push({ file: f, title, slug: s });
          } catch {
            items.push({ file: f, title: "Untitled", slug: slug(f) });
          }
        }
        const seen = new Map();
        for (const it of items) {
          const base = it.slug || "article";
          const n = (seen.get(base) || 0) + 1;
          seen.set(base, n);
          if (n > 1) it.slug = `${base}-${n}`;
        }
        return items;
      }

      async function route() {
        const hash = location.hash || "#/";
        try {
          if (hash === "#/about") {
            show("#aboutView");
            return;
          }

          const files = await loadIndex();
          const items = await buildItems(files);

          if (hash.startsWith("#/article/")) {
            const s = decodeURIComponent(hash.split("/").pop() || "");
            const match = items.find((x) => x.slug === s);
            if (!match) {
              show("#listView");
              renderList(items);
              return;
            }

            const md = await fetchText(match.file);
            qs("#articleTitle").textContent = match.title;
            qs("#articleBody").innerHTML = marked.parse(stripLeadingH1(md));
            show("#articleView");
            wireCopyLink();
            return;
          }

          show("#listView");
          renderList(items);
        } catch {
          show("#listView");
          const list = qs("#articleList");
          list.innerHTML =
            '<div class="p-5 rounded-3xl border-2 border-zinc-300 dark:border-zinc-700 text-zinc-700 dark:text-zinc-200">Unable to load articles. Check /articles/index.json and file paths.</div>';
        }
      }

      function startLoader() {
        const loader = qs("#loader");
        window.setTimeout(() => {
          loader.classList.add("hidden");
          loader.setAttribute("aria-busy", "false");
        }, 5000);
      }

      window.addEventListener("hashchange", route);
      startLoader();
      route();
    </script>
  </body>
</html>
